{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {
    "collapsed": true
   },
   "outputs": [],
   "source": [
    "\n",
    "\n",
    "```python\n",
    "# This pandas script reads an input file containing sales data, and produces eigth different reports summarizing these data.\n",
    "# Data in the input file are assumed to be in json format.\n",
    "# The input file is assumed to be in the same directory where this script resides.\n",
    "#\n",
    "# The code for each report is contained in a single cell and includes comments that detail its logic and operations.\n",
    "#\n",
    "# At a high level, each of these cells defines a data frame corresponding to the report it produces. The elements of these\n",
    "#   data frames are calculated/filled-in as expalined in the comments throughout this script.\n",
    "#\n",
    "```\n",
    "\n",
    "# Observations\n",
    "1. Lots of products (183); low average price ($2.93); total revenue of $2,286. It's not clear over what time span these data were produced, but this seems to be a lot of work for little return.\n",
    "2. Predominantly male customer base: male 81%, female 17.5%, other 1.5%.\n",
    "3. Purchasing profiles\n",
    "   - 63% of revenue 15-25 group, 24% + 39%\n",
    "   - Many small purchases: top 5 spenders collectively account for <3% of revenue\n",
    "   -Top 5 popular products account for 7.5% of revenue\n",
    "   -Top 5 profitable products generate 8% of revenue\n",
    "# Actions\n",
    "* Conduct an ROI analysis to see if all this activity can be justified and contributes to the bottom line.\n",
    "* Assuming it makes sense to continue sales\n",
    "  - Explore under-covered demographics, especially female and LGBT community\n",
    "  - Analyze product structure and look for consilidation opportunities to simplify product structure\n",
    "\n",
    "\n",
    "```python\n",
    "# There is only one dependency: pandas\n",
    "import pandas as pd\n",
    "```\n",
    "\n",
    "\n",
    "```python\n",
    "# Read the input file into a data frame for subsequent processing and analysis\n",
    "file_path='purchase_data.json'\n",
    "data_df=pd.read_json(file_path)\n",
    "data_df.head()   # output the first five rows of input data for future reference\n",
    "```\n",
    "\n",
    "\n",
    "```python\n",
    "# Rename column 'Item ID' to 'Item_ID' to convert the space character to an underscore (_); this facilitates easier\n",
    "#   reference to this column in code cells below.\n",
    "data_df=data_df.rename(columns={\"Item ID\":\"Item_ID\"})\n",
    "```\n",
    "\n",
    "\n",
    "```python\n",
    "# This first report produces a single data point: total number of players present in the input file.\n",
    "# This value corresponds to the number of unique instances in the SN (screen name) column and is determined by using\n",
    "#   method nunique().\n",
    "#\n",
    "total_unique_players=data_df['SN'].nunique()\n",
    "Total_Players_df=pd.DataFrame({\"Total Players\":[total_unique_players]})\n",
    "Total_Players_df.head()  # output is passed through head() to produce consistent output with other reports below\n",
    "```\n",
    "\n",
    "\n",
    "```python\n",
    "# This code cell conducts an overall Purchasing Analysis (Total) and produces the following output:\n",
    "#   Number of unique items, Avg purchase price, Total number of purchases and Total revenue\n",
    "#\n",
    "# Start with determining various high level data points, such as number of unique items and number of purchases.\n",
    "#\n",
    "num_unique_items = data_df['Item_ID'].nunique()  # Use nunique() on Item_ID column to determine no. of unique items\n",
    "num_purchases = len(data_df.index)               # Number of purchases is simply the length of the overall data frame index\n",
    "average_price= data_df['Price'].mean()           # Average price is determined using mean() method on the Price column\n",
    "total_rev = average_price * num_purchases        # Total revenue is the product of average price and number of purchases\n",
    "\n",
    "# Now store all the above values into a data frame for final formatting and output:\n",
    "PurchaseAnalysisTotal_df = pd.DataFrame ({\"Number of Unique Items\" : [num_unique_items],\n",
    "                               \"average_price\" : [average_price],\n",
    "                               \"Number of Purchases\" : [num_purchases],\n",
    "                               \"total_revenue\" : [total_rev]\n",
    "                               })\n",
    "# Fix the formatting and the order of columns, to match the format provided in the example:\n",
    "PurchaseAnalysisTotal_df ['Average Price'] = PurchaseAnalysisTotal_df['average_price'].map('${:,.2f}'.format)\n",
    "PurchaseAnalysisTotal_df ['Total Revenue'] = PurchaseAnalysisTotal_df['total_revenue'].map('${:,.2f}'.format)\n",
    "PurchaseAnalysisTotal_df = PurchaseAnalysisTotal_df [['Number of Unique Items', 'Average Price', 'Number of Purchases', 'Total Revenue']]\n",
    "\n",
    "# And print the resulting data frame:\n",
    "PurchaseAnalysisTotal_df.head()\n",
    "```\n",
    "\n",
    "\n",
    "```python\n",
    "# This code cell conducts an overall Geder Demographics analysis and produces the following output:\n",
    "#   Percentage & count of male, female and other/non-disclosed players.\n",
    "#\n",
    "# Start with grouping the overall data by gender, using groupby(), and determining various high level data points such as \n",
    "#   the number of various geneder groups.\n",
    "#\n",
    "gender_groups = data_df.groupby('Gender')\n",
    "\n",
    "# Capture the number of players of each gender using count(). The first element in the count() output corresponds to females,\n",
    "#    the second element corresponds to males, and the third element corresponds to other/un-disclosed.\n",
    "num_female_players, num_male_players, num_other_players = gender_groups['Gender'].count()\n",
    "total_players = num_female_players + num_male_players + num_other_players\n",
    "\n",
    "# Now store all the above data into a data frame for final formatting and output:\n",
    "Gender_df = pd.DataFrame ({\"Male\" : [num_male_players, (num_male_players/total_players)*100],\n",
    "                           \"Female\" : [num_female_players, (num_female_players/total_players)*100],\n",
    "                           \"Other / Non-Disclosed\" : [num_other_players, (num_other_players/total_players)*100]\n",
    "                              })\n",
    "# Transpose the rows and columns of the report data frame, and fix the order of columns to match the format provided \n",
    "#    in the example:\n",
    "Gender_df = Gender_df.T\n",
    "Gender_df = Gender_df.rename(columns={0:\"Total Count\"})\n",
    "Gender_df = Gender_df.rename(columns={1:\"Percentage of Players\"})\n",
    "Gender_df = Gender_df [['Percentage of Players', 'Total Count']]\n",
    "# And print the resulting data frame, passing it through head() for consistent formatting\n",
    "# TG\n",
    "\n",
    "ender_df.sort_values(by='Total Count', ascending=False).head()\n",
    "```\n",
    "\n",
    "\n",
    "```python\n",
    "# This code cell conducts a gender-based Purchasing Analysis (Gender), producing the following output for each geneder group:\n",
    "#   Count of Purchases, Average Selling price, Total Purchase Value and Normalized Total.\n",
    "#\n",
    "# Start with building data frames for each gender group, containing report data points for each group.\n",
    "# Build each geneder-group data frame using loc operator, to find all rows for a given group in the overall data frame.\n",
    "#\n",
    "female_activity_df = data_df.loc[data_df['Gender'] == 'Female',:]\n",
    "female_purchase_count = len(female_activity_df.index)\n",
    "female_purcahse_avg_price = female_activity_df['Price'].mean()\n",
    "female_purchase_total = female_purcahse_avg_price * female_purchase_count\n",
    "female_purchase_normalized = female_purchase_total / num_female_players\n",
    "\n",
    "male_activity_df = data_df.loc[data_df['Gender'] == 'Male',:]\n",
    "male_purchase_count = len(male_activity_df.index)\n",
    "male_purcahse_avg_price = male_activity_df['Price'].mean()\n",
    "male_purchase_total = male_purcahse_avg_price * male_purchase_count\n",
    "male_purchase_normalized = male_purchase_total / num_male_players\n",
    "\n",
    "other_activity_df = data_df.loc[data_df['Gender'] == 'Other / Non-Disclosed',:]\n",
    "other_purchase_count = len(other_activity_df.index)\n",
    "other_purcahse_avg_price = other_activity_df['Price'].mean()\n",
    "other_purchase_total = other_purcahse_avg_price * other_purchase_count\n",
    "other_purchase_normalized = other_purchase_total / num_other_players\n",
    "\n",
    "# Now store all the above data points into a data frame for final formatting and output:\n",
    "PurchaseAnalysisGender_df = pd.DataFrame ({\n",
    "                               \"Male\" : [male_purchase_count, male_purcahse_avg_price, male_purchase_total, male_purchase_normalized],\n",
    "                               \"Female\" : [female_purchase_count, female_purcahse_avg_price, female_purchase_total, female_purchase_normalized],\n",
    "                               \"Other / Non-Disclosed\" : [other_purchase_count, other_purcahse_avg_price, other_purchase_total, other_purchase_normalized]\n",
    "                              })\n",
    "\n",
    "# Transpose the rows and columns of the report data frame and rename columns for better code readability:\n",
    "PurchaseAnalysisGender_df = PurchaseAnalysisGender_df.T\n",
    "PurchaseAnalysisGender_df = PurchaseAnalysisGender_df.rename(columns={0:\"Purchase Count\"})\n",
    "PurchaseAnalysisGender_df = PurchaseAnalysisGender_df.rename(columns={1:\"avg_price\"})\n",
    "PurchaseAnalysisGender_df = PurchaseAnalysisGender_df.rename(columns={2:\"tot_value\"})\n",
    "PurchaseAnalysisGender_df = PurchaseAnalysisGender_df.rename(columns={3:\"normalized\"})\n",
    "\n",
    "# Note that columns containing currency data points are of type float; these columns need need to be reformatted (and \n",
    "#    effectvely converted to strings) so they are diaplayed in the same manner as in the sample file. Hence, the need for \n",
    "#    additional columns which will contain properly formatted currency figures:\n",
    "PurchaseAnalysisGender_df [\"Average Purchase Price\"] = PurchaseAnalysisGender_df[\"avg_price\"].map('${:,.2f}'.format)\n",
    "PurchaseAnalysisGender_df [\"Total Purchase Value\"] = PurchaseAnalysisGender_df[\"tot_value\"].map('${:,.2f}'.format)\n",
    "PurchaseAnalysisGender_df [\"Normalized Totals\"] = PurchaseAnalysisGender_df[\"normalized\"].map('${:,.2f}'.format)\n",
    "# Now drop columns containing currency figures saved as type float, and produce the final report output\n",
    "PurchaseAnalysisGender_df = PurchaseAnalysisGender_df [['Purchase Count', 'Average Purchase Price', \n",
    "                                                        'Total Purchase Value', 'Normalized Totals']]\n",
    "\n",
    "PurchaseAnalysisGender_df.head()\n",
    "```\n",
    "\n",
    "\n",
    "```python\n",
    "# This code cell conducts an age-based (Age Demographics) analysis and produces a report containing:\n",
    "#   Purchase Count, Average Purchase Price, Total Purchase Value and Normalized Totals.\n",
    "#\n",
    "# Start the process by binning all the input data into 8 age groups each spanning four years.\n",
    "#   This is done using the cut() method.  Aadd a new column which contains the corresponsing age group label for \n",
    "#   each record in the input data.\n",
    "#\n",
    "age_bins = [0, 10, 15, 20, 25, 30, 35, 40, 100]  # The last bin is set to a high value , \n",
    "bin_labels = ['<10', '10-15', '15-20', '20-25', '25-30', '30-35', '35-40', '40+']\n",
    "data_df['Age Bin']=pd.cut(data_df['Age'], age_bins, labels=bin_labels)\n",
    "age_group_purchases = data_df.groupby('Age Bin')  # Group all the input data using this freshly added coloumn\n",
    "\n",
    "# Define the report data frame for final output, and initialize various fields to zero's.  Note that columns containing\n",
    "#   currency info are of type float and will need to be converted/formatted for proper display.\n",
    "# There are a total of 8 age groups, hence each column is initialized with a list comprised of 8 zeros:\n",
    "PurchaseAnalysisAge_df = pd.DataFrame ({\n",
    "                               \"Purchase Count\" : [0,0,0,0,0,0,0,0],\n",
    "                               \"avg_price\" : [0,0,0,0,0,0,0,0],\n",
    "                               \"tot_purchase_val\" : [0,0,0,0,0,0,0,0],\n",
    "                               \"normalized\" : [0,0,0,0,0,0,0,0]\n",
    "                              })\n",
    "# Start calculating the values for various fields in the report data frame:\n",
    "#\n",
    "PurchaseAnalysisAge_df['avg_price'] = age_group_purchases['Price'].mean().values\n",
    "PurchaseAnalysisAge_df['Purchase Count'] = age_group_purchases['Price'].count().values\n",
    "PurchaseAnalysisAge_df['tot_purchase_val'] = PurchaseAnalysisAge_df['avg_price'] * PurchaseAnalysisAge_df['Purchase Count']\n",
    "PurchaseAnalysisAge_df['Age Bracket Count'] = data_df['Age Bin'].value_counts().values\n",
    "PurchaseAnalysisAge_df['normalized'] = PurchaseAnalysisAge_df['tot_purchase_val'] / PurchaseAnalysisAge_df['Age Bracket Count']\n",
    "\n",
    "# create new columns which contain reformatted data of type float, to properly display currency info:\n",
    "PurchaseAnalysisAge_df ['Average Price'] = PurchaseAnalysisAge_df['avg_price'].map('${:,.2f}'.format)\n",
    "PurchaseAnalysisAge_df ['Total Purchase Value'] = PurchaseAnalysisAge_df['tot_purchase_val'].map('${:,.2f}'.format)\n",
    "PurchaseAnalysisAge_df ['Normalized Totals'] = PurchaseAnalysisAge_df['normalized'].map('${:,.2f}'.format)\n",
    "\n",
    "# Finally, select and set the order of columns, to match the sample file:\n",
    "PurchaseAnalysisAge_df = PurchaseAnalysisAge_df [['Purchase Count', 'Average Price', 'Total Purchase Value', 'Normalized Totals']]\n",
    "PurchaseAnalysisAge_df.index = bin_labels\n",
    "# Output the report by sending it through head(10) since there are 8 actual records to display:\n",
    "PurchaseAnalysisAge_df.head(10)\n",
    "```\n",
    "\n",
    "\n",
    "```python\n",
    "# This code cell produces a report of Top 5 Spenders based on the total purchase value, including:\n",
    "#   SN, Purchase Count, Average Purchase Price, Total Purchase Value.\n",
    "#\n",
    "# Start by grouping all the input data based on buyers screen name (SN), using groupby() method.\n",
    "#\n",
    "# Calculate various fields using count() and mean() methods applied to the groupby object:\n",
    "#\n",
    "sales_by_SN = data_df.groupby('SN')\n",
    "SN_sales_df = pd.DataFrame({'Purchase Count' : sales_by_SN['Item_ID'].count(),\n",
    "                            'avg_price' : sales_by_SN['Price'].mean(),\n",
    "                            'tot_purchase' : sales_by_SN['Item_ID'].count() * sales_by_SN['Price'].mean()\n",
    "})\n",
    "\n",
    "# Create new columns which contain reformatted data of type float, to properly display currency info:\n",
    "SN_sales_df ['Average Purchase Price'] = SN_sales_df['avg_price'].map('${:,.2f}'.format)\n",
    "SN_sales_df ['Total Purchase Value'] = SN_sales_df['tot_purchase'].map('${:,.2f}'.format)\n",
    "\n",
    "# Select and set the order of columns, to match the sample file:\n",
    "SN_sales_df = SN_sales_df [['Purchase Count', 'Average Purchase Price', 'Total Purchase Value']]\n",
    "\n",
    "# Produce the final report by sorting the report data frame based on Total Purchase Value, and outputing the first\n",
    "#   five rows using head():\n",
    "SN_sales_df.sort_values(by='Total Purchase Value', ascending=False).head()\n",
    "```\n",
    "\n",
    "\n",
    "```python\n",
    "# This code cell produces the 5 Most Popular Items based on purchase count; the report includes:\n",
    "#   Item ID, Item Name, Purchase Count, Item Price, Total Purchasse Value\n",
    "#\n",
    "# Start the process by grouping all the input data by Item_ID, using groupby() method:\n",
    "item_sales = data_df.groupby('Item_ID')\n",
    "\n",
    "# The code below produces a dictionary which maps Item_ID to Price; this dictionary is then used in building the report data frame.\n",
    "# First define a function which accepts and item id and returns its corresponding price. Price is looked up in the\n",
    "#   input data, which returns a Series. The first element of this series contains the price.\n",
    "# Build the dictionary by iterating over all the unique instances of Item_ID in the input data, and retreive its corresponding\n",
    "#   price using the function described above:\n",
    "item_prices = []  # define empty dictionary; key is item_id and value is its price\n",
    "def return_price(itemid):\n",
    "    return data_df.loc[data_df.Item_ID==itemid]['Price'].iloc[0]\n",
    "for item in data_df['Item_ID'].unique():\n",
    "    item_prices.append(return_price(item))\n",
    "\n",
    "# Define the report data frame and populate its various fields using unique() and count() methods:\n",
    "item_sales_df = pd.DataFrame ({'Item Name' : item_sales['Item Name'].unique(),\n",
    "                               'Purchase Count' : item_sales['Item_ID'].count().values,\n",
    "                               'price' : item_prices,\n",
    "                               'tot_pvalue' : item_sales['Item_ID'].count().values * item_prices\n",
    "                              })\n",
    "# Save the data frame with numeric values for the next report below\n",
    "item_sales_numeric = item_sales_df\n",
    "\n",
    "# Create new columns which contain reformatted data of type float, to properly display currency info:\n",
    "item_sales_df ['Item Price'] = item_sales_df['price'].map('${:,.2f}'.format)\n",
    "item_sales_df ['Total Purchase Value'] = item_sales_df['tot_pvalue'].map('${:,.2f}'.format)\n",
    "\n",
    "# Select and set the order of columns, to match the sample file:\n",
    "item_sales_df = item_sales_df [['Item Name', 'Purchase Count', 'Item Price', 'Total Purchase Value']]\n",
    "\n",
    "# Produce the final report by sorting the report data frame based on Purchase Count, and passing the result to head() which\n",
    "#   outputs the first 5 rows.\n",
    "item_sales_df.sort_values(by='Purchase Count', ascending=False).head()\n",
    "```\n",
    "\n",
    "```python\n",
    "# This code cell produces the 5 most profitable items by total purchase value; the report includes:\n",
    "#   Item ID, Item Name, Purchase Count, Item Price, Total Purchase Value\n",
    "# This report uses the data frame saved above:\n",
    "#\n",
    "# First sort this data frame which contains numeric values for total purchase values:\n",
    "item_sales_df = item_sales_numeric.sort_values(by='tot_pvalue', ascending=False)\n",
    "\n",
    "# Select and set the order of columns, to match the sample file:\n",
    "item_sales_df = item_sales_df [['Item Name', 'Purchase Count', 'Item Price', 'Total Purchase Value']]\n",
    "\n",
    "# Produce the output by passing the report data frame to head() (the data frame is already sorted):\n",
    "item_sales_df.head()\n",
    "```\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {
    "collapsed": true
   },
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.6.3"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 2
}
